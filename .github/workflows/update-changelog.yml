name: Update CHANGELOG from GitHub Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Update CHANGELOG
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const release = context.payload.release;
            const tag = release.tag_name;
            const title = tag.replace(/^v/, '');
            const date = release.published_at.substring(0, 10);
            let body = release.body || 'No release notes provided.';
            body = body.replace(/## What's Changed/g, "### What's Changed");

            const changelogPath = 'CHANGELOG.md';

            const newEntry = `## [${title}] - ${date}\n${body}\n`;

            console.log('----- NEW CHANGELOG ENTRY START -----');
            console.log(newEntry);
            console.log('----- NEW CHANGELOG ENTRY END -----');

            let changelog = '';
            if (fs.existsSync(changelogPath)) {
              changelog = fs.readFileSync(changelogPath, 'utf8');
            } else {
              changelog = '# Changelog\n\nAll notable changes to this project will be documented in this file.\n';
            }

            // Insert after the first header
            const updated = changelog.replace(
            /(#[^\n]*\n)/,
            `$1${newEntry}`
            );

            fs.writeFileSync(changelogPath, updated);

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout ${{ github.event.repository.default_branch }}
          git add CHANGELOG.md
          git commit -m "chore: update changelog for ${{ github.event.release.tag_name }}"
          git push
